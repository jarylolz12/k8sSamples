ARG NODE_VERSION
FROM node:${NODE_VERSION}-alpine as build-stage

# we use ARG to set the values of ENV dynamically
ARG VUE_APP_BASE_URL
ARG VUE_APP_PO_URL
ARG VUE_APP_ACCOUNTING_URL
ARG VUE_APP_ACCOUNTING_SERVICE_ORIGIN
ARG VUE_APP_ACCOUNTING_SERVICE_KEY
ARG VUE_APP_TRUCKING_URL
ARG VUE_APP_PUSHER_HOST
ARG VUE_APP_PUSHER_ENC
ARG VUE_APP_PUSHER_PORT
ARG VUE_APP_PUSHER_KEY
ARG VUE_APP_PUSHER_CLUSTER
ARG VUE_APP_PO_NOTIFICATION_CHANNEL

# we use ENV to make it persistent across builds
ENV VUE_APP_BASE_URL=${VUE_APP_BASE_URL}
ENV VUE_APP_PO_URL=${VUE_APP_PO_URL}
ENV VUE_APP_ACCOUNTING_URL=${VUE_APP_ACCOUNTING_URL}
ENV VUE_APP_ACCOUNTING_SERVICE_ORIGIN=${VUE_APP_ACCOUNTING_SERVICE_ORIGIN}
ENV VUE_APP_ACCOUNTING_SERVICE_KEY=${VUE_APP_ACCOUNTING_SERVICE_KEY}
ENV VUE_APP_TRUCKING_URL=${VUE_APP_TRUCKING_URL}
ENV VUE_APP_PUSHER_HOST=${VUE_APP_PUSHER_HOST}
ENV VUE_APP_PUSHER_ENC=${VUE_APP_PUSHER_ENC}
ENV VUE_APP_PUSHER_PORT=${VUE_APP_PUSHER_PORT}
ENV VUE_APP_PUSHER_KEY=${VUE_APP_PUSHER_KEY}
ENV VUE_APP_PUSHER_CLUSTER=${VUE_APP_PUSHER_CLUSTER}
ENV VUE_APP_PO_NOTIFICATION_CHANNEL=${VUE_APP_PO_NOTIFICATION_CHANNEL}
ENV NODE_OPTIONS="--max-old-space-size=5120"


WORKDIR /app
COPY package.json ./
COPY package-lock.json ./
RUN npm install --force --global yarn
RUN yarn install
COPY .env.local.example .
COPY . .
RUN yarn build  

FROM nginx:1.22-alpine as production-stage
WORKDIR /app
COPY --from=build-stage /app/dist /app
COPY nginx.conf /etc/nginx/nginx.conf